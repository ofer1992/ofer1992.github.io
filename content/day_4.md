Title: Switching Logseq's git dependency from dugite to isomorphic-git: The journey so far
Date: 2024-05-08 18:10
Category: Life
Status: draft

## The goal
A short recap of where we are (will probably refactor this to retroactive posts eventually): I'm trying to switch logseq's git dependency from `dugite` to `isomorphic-git`, so it can run on android, browser etc. The problem with dugite is that it depends on the presence of a git client. Since git in logseq is only expected to work on a pc or mac using electron, the implementation is tied to electron specific code like a separate config and state, and a different access to the file system. Also, dugite can run arbitrary git commands while iso-git has specific functions that implement most of the functionality of git, but obviously it is more restricted.

## Day 1 - Warming up with ClojureScript, interop with isomorphic-git
Since logseq is written in ClojureScript, the first step was setting up the dev environment. It is luckily relatively well-documented. Of course, in my opinion clojure's general dev environment is quite clunky. Maybe I'm spoiled, having come from python which is interpreted language, and with which I have much experience, but I never quite manage to wrap my head around all the scaffolding required for clojure development. You need java, and clojure, initialize the project in a certain way, and then you compile and run it (or run it with one of the clojure CLI commands). This is the barebones setup, but of course you want a repl, so you need some more tools. I use VSCode+Calva. And you also have build tools like leiningen or shadow-cljs, and then there's all the interop with java/javascript. Now, a lot of effort has went to make things work out-of-the-box, but still, there's a lot of complexity going on which in the end is still leaky. Sorry for the rant, but I had to get it off my chest.

After setting up and figuring out the program's endpoints and different execution modes (browser or electron, haven't touched mobile yet), I scanned the source code for usage of git. The first hurdle was to figure out the javascript interop. You can call javascript functions directly from clojurescript, which is super neat, but it takes some figuring out the right syntax. Here ChatGPT was a big help, basically helping me do it in minutes instead of an hour in the worst case. Another hurdle was promises. iso-git uses promises for all the operations, and for some reason things were not working as I expected. Prints weren't printing. Again, this is a classic example of the dillema of going deep on subjects or hacking along. I'm not very knowledgable of concurrent programming, and especially not in clojure, so it was very challenging for me to understand what's going on, or what sanity checks should I do. In the end I also figured out that the problem was really just printing: depending on the usage of `js/console.log` vs `println` or `prn` you get prints in either the browser console or the repl output or wherever. So that's was a lesson learned with sweat and tears. In fact, this whole process, as we will see, exemplifies the sweat and tears required to learn these lessons.

## Day 2 - Actually writing some code
I then moved on to rewriting the basic git functions in the code with isomorphic-git. Again, with the help of Copilot and ChatGPT, this process went fairly smoothly, and thanks to the repl, it's very quick to check that the functions behave as expected. By this point I got the electron version to work with the new implementations of the git functionality. Clearly all that remained was to reenable the git tab in the settings modal. A quick look through the code led me to the test that checks if electron is running and only then displaying the git setting, which gladly commented out. Immediately the tab appeared in the browser version.

I patted myself on the back for my success, but then quickly realized this was the easy part. Nothing was actually happening on the git side. You see, since using dugite already restricted the git integration to computers, the code naturally became tied to the electron build, so the git configuration and the callbacks that manage the git lifecycle didn't actually work. I had to refactor those dependencies out to the more general `frontend` build.

## Day 3 - Moving state from electron to frontend

## Day 4 - How do I even access the file system